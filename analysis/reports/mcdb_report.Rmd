---
title: "SV report"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(drake)
library(dplyr)
library(ggplot2)
library(cats)


## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("analysis", "drake", "drake-cache-mcdb.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

loadd(all_results, cache = cache)

alldat <- as.list(cached(cache = cache)[ which(substr(cached(cache = cache), 0, 6) == "s_spab")])
alldat <- lapply(alldat, FUN = readd, cache = cache, character_only = T)
allsv <- lapply(alldat, FUN = get_statevars_ts)
allsv <- bind_rows(allsv)

all_results <- left_join(all_results, allsv, by = c("site", "singletons", "dat", "source", "sim", "timestep"))

all_results <- all_results %>%
  group_by(site, singletons, dat, source) %>%
  mutate(mean_skew = mean(skew_percentile),
         sd_skew = sd(skew_percentile),
         mean_simpson = mean(simpson_percentile),
         sd_simpson = sd(simpson_percentile),
         med_skew = median(skew_percentile),
         med_simpson = median(simpson_percentile),
         skew_25 = quantile(skew_percentile, probs = .25),
         simpson_75 = quantile(simpson_percentile, probs = .75),
         skew_high = 100 * mean(skew_percentile >= 95),
         simpson_low = 100*mean(simpson_percentile <= 5),
         ntimesteps = length(unique(timestep))) %>%
  ungroup()
```

## Nsamples

The maximum number of samples is `r max(all_results$nsamples)`.

The minimum number of samples is `r min(all_results$nsamples)`.

```{r show nsamples, fig.height = 15}
nsamples_heatmap <- ggplot(data = all_results, aes(x = log(s0), y = log(n0), color = nsamples)) +
  geom_point(alpha = .1) +
  facet_wrap(vars(singletons), ncol = 2, scales = "free_y") +
  theme_bw() +
  ggtitle("Nsamples") +
  scale_color_viridis_c(option = "plasma", end = .8)
nsamples_heatmap
```

There's a considerable region of fewer than 2500 samples achieved. I think to have any confidence in results, we need to at least filter out those with fewer than 500. 

## Ntimesteps

The maximum number of timesteps is `r max(all_results$ntimesteps)`.

The minimum number of timesteps is `r min(all_results$ntimesteps)`.

```{r nsites with 1 ts} 

one_ts <- length(unique(filter(all_results, ntimesteps==1)$site))

```

There are `r one_ts` sites with just one timestep. Removing those for this plot:

```{r show ntimesteps, fig.height = 15}
nts_heatmap <- ggplot(data = distinct(select(filter(all_results, ntimesteps > 1), site, ntimesteps, singletons, s0, n0)), aes(x = log(s0), y = log(n0), color = ntimesteps)) +
  geom_point(alpha = .5) +
  facet_wrap(vars(singletons), ncol = 2, scales = "free_y") +
  theme_bw() +
  ggtitle("Ntimesteps") +
  scale_color_viridis_c(option = "plasma", begin = .1, end = .8)
nts_heatmap

nts_histogram <- ggplot(data = distinct(select(filter(all_results, ntimesteps > 1), site, ntimesteps, singletons)), aes(x = ntimesteps)) +
  geom_histogram() +
   facet_wrap(vars(singletons), ncol = 2, scales = "free_y") +
  theme_bw() +
  ggtitle("Ntimesteps")
```

The vast majority of the TS sites have fewer than 5 time steps. The one that doesn't is Portal.

```{r plot ts, fig.height = 15, fig.width = 30}

ts_results <- filter(all_results, ntimesteps > 1)

s0_ts <- ggplot(data = filter(ts_results, nsamples >= 500), aes(x = timestep, y = s0, color = singletons)) + 
  geom_point() +
  theme_bw() +
  facet_wrap(vars(site), ncol = 7, scales = "free_x") +
  scale_color_viridis_d(end =.8) +
  ggtitle("S") +
  theme(legend.position = "none")


skew_ts <- ggplot(data = filter(ts_results, nsamples >= 500), aes(x = timestep, y = skew_percentile, color = singletons, group = singletons)) +
  geom_point() +
  # geom_label(aes(x = 1980, y = 50, label = signif(mean_skew, 3)), position = position_dodge(15)) +
  # geom_label(aes(x = 1980, y = 15, label = signif(sd_skew, 2)), position = position_dodge(15), size = 3) +
  theme_bw() +
  facet_wrap(vars(site), ncol = 7, scales = "free_x") +
  scale_color_viridis_d(end =.8) +
  ggtitle("Skew") +
  ylim(0, 100)+
  theme(legend.position = "none")

gridExtra::grid.arrange(grobs = list(skew_ts, s0_ts), ncol = 2)


simpson_ts <- ggplot(data = filter(ts_results, nsamples >= 500), aes(x = timestep, y = simpson_percentile, color = singletons, group = singletons)) +
  geom_point() +
  theme_bw() +
  # geom_label(aes(x = 1980, y = 50, label = signif(mean_simpson, 3)), position = position_dodge(25)) +
  # geom_label(aes(x = 1980, y = 15, label = signif(sd_simpson, 2)), position = position_dodge(25), size = 3) +
  facet_wrap(vars(site), ncol = 7, scales = "free_x") +
  scale_color_viridis_d(end =.8) +
  ggtitle("Simpson") +
  ylim(0, 100)+
  theme(legend.position = "none")


gridExtra::grid.arrange(grobs = list(simpson_ts, s0_ts), ncol = 2)



```

